<?php
/*
Plugin Name: GitHub
Plugin URI: http://novoda.com/
Description: Minimalist GitHub plugin
Author: Carl Harroch
Version: 1
Author URI: http://novoda.com/
*/
error_reporting(E_ALL);
add_action("widgets_init", array('GitHub', 'register'));
register_activation_hook( __FILE__, array('GitHub', 'activate'));
register_deactivation_hook( __FILE__, array('GitHub', 'deactivate'));
class GitHub {
  function activate(){
    $data = 'novoda';
    if ( ! get_option('github_user')){
      add_option('github_user' , $data);
    } else {
      update_option('github_user' , $data);
    }
  }
  function deactivate(){
    delete_option('github_user');
  }
    function control(){
      $data = get_option('github_user');
      ?>
      <p><label>GitHub User: <input name="github_user" type="text" value="<?php echo $data['github_user']; ?>" /></label></p>
      <?php
       if (isset($_POST['github_user'])){
        $data['github_user'] = attribute_escape($_POST['github_user']);
        update_option('github_user', $data);
      }
    }
  function widget($args){
    echo $args['before_widget'];
    echo $args['before_title'] . 'GitHub' . $args['after_title'];
    $curl_handle=curl_init();
    curl_setopt($curl_handle,CURLOPT_URL,'http://github.com/api/v2/json/repos/show/' . get_option('github_user'));
    curl_setopt($curl_handle,CURLOPT_CONNECTTIMEOUT,2);
    curl_setopt($curl_handle,CURLOPT_RETURNTRANSFER,1);
    $buffer = curl_exec($curl_handle);
    curl_close($curl_handle);
    if (empty($buffer)){
    } else {
        $json = json_decode($buffer);
        $template = '<li><a title="%s" href="%s">%s</a></li>';
        echo "<ul>";
        foreach($json->{'repositories'} as $repo) {
        	printf($template, $repo->{'name'}, $repo->{'url'}, $repo->{'name'});
        }
	    echo "</ul>";
    }
    echo $args['after_widget'];
  }
  function register(){
    register_sidebar_widget('GitHub', array('GitHub', 'widget'));
    register_widget_control('GitHub', array('GitHub', 'control'));
  }
}
?>

